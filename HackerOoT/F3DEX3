FROM ubuntu:24.04 AS build

# usage: `docker buildx build -f F3DEX3 -o out .` or `docker buildx build -f HackerOoT/F3DEX3 -o HackerOoT/out ./HackerOoT/`

ENV TZ=UTC
ENV LANG=C.UTF-8

RUN apt-get update && \
    apt-get install -y \
    git \
    build-essential \
    binutils-mips-linux-gnu \
    curl \
    python3 \
    python3-pip \
    python3-venv \
    libpng-dev \
    libxml2-dev \
    gcc-mips-linux-gnu \
    cmake \
    zip

# clone the necessary repos
RUN git clone -b master --single-branch --recursive https://github.com/Kingcom/armips.git
RUN git clone -b main --single-branch --recursive https://github.com/HackerN64/F3DEX3.git
RUN git clone -b main --single-branch --recursive https://github.com/HackerN64/HackerOoT.git

# build armips
RUN cd armips && \
    mkdir build && cd build && \
    cmake -DCMAKE_BUILD_TYPE=Release .. && \
    cmake --build .

# build F3DEX3
ENV ARMIPS=/armips/build/armips
RUN cd F3DEX3 && \
    make all -j$(nproc)

# create F3DEX3 patches
COPY in /host_in
RUN cp -v host_in/baseroms/gc-eu-mq-dbg/baserom.z64 HackerOoT/baseroms/gc-eu-mq-dbg/baserom.z64 && \
    cp -v host_in/baseroms/ntsc-1.2/baserom.z64 HackerOoT/baseroms/ntsc-1.2/baserom.z64 && \
    cp -v F3DEX3/build/F3DEX3_BrW*/F3DEX3_BrW*.code HackerOoT/F3DEX3/n64/ && \
    cp -v F3DEX3/build/F3DEX3_BrW*/F3DEX3_BrW*.data HackerOoT/F3DEX3/n64/ && \
    cp -v F3DEX3/build/F3DEX3_BrW*/F3DEX3_BrW*.code HackerOoT/F3DEX3/gc/ && \
    cp -v F3DEX3/build/F3DEX3_BrW*/F3DEX3_BrW*.data HackerOoT/F3DEX3/gc/

ENV PYTHON=/HackerOoT/.venv/bin/python3
RUN cd HackerOoT && \
    make venv && \
    cd tools/Flips && make -j$(nproc) TARGET=cli && cd /HackerOoT && \
    $PYTHON tools/decompress_baserom.py gc-eu-mq-dbg && \
    $PYTHON tools/decompress_baserom.py ntsc-1.2 && \
    rm -rf F3DEX3/*/*.bps && \
    make create_f3dex3_patches -j$(nproc) PLATFORM=N64 && \
    make create_f3dex3_patches -j$(nproc) PLATFORM=GC && \
    zip F3DEX3_patches.zip F3DEX3/n64/*.bps F3DEX3/gc/*.bps

# export artifacts
FROM scratch AS artifacts
COPY --from=build /HackerOoT/F3DEX3_patches.zip /
